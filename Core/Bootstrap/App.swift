import MagicKit
import OSLog
import Sparkle
import SwiftUI

/// ä¸»åº”ç”¨å…¥å£ï¼Œè´Ÿè´£åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œæ ¸å¿ƒæœåŠ¡åˆå§‹åŒ–
@main
struct CoreApp: App, SuperLog {
    /// æ—¥å¿—æ ‡è¯†ç¬¦
    nonisolated static let emoji = "ðŸŽ"

    /// æ˜¯å¦å¯ç”¨è¯¦ç»†æ—¥å¿—è¾“å‡º
    nonisolated static let verbose = false

    /// macOS åº”ç”¨ä»£ç†ï¼Œå¤„ç†åº”ç”¨çº§åˆ«çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶
    @NSApplicationDelegateAdaptor private var appDelegate: MacAgent

    /// Sparkle æ›´æ–°æŽ§åˆ¶å™¨ï¼Œæä¾›åº”ç”¨è‡ªåŠ¨æ›´æ–°åŠŸèƒ½
    private let updaterController: SPUStandardUpdaterController

    /// åº”ç”¨æä¾›è€…ï¼Œç®¡ç†åº”ç”¨çŠ¶æ€å’Œæ•°æ®
    @StateObject private var appProvider = AppProvider()

    /// æ’ä»¶æä¾›è€…ï¼Œç®¡ç†æ’ä»¶ç”Ÿå‘½å‘¨æœŸ
    @StateObject private var pluginProvider = PluginProvider()

    init() {
        // åˆå§‹åŒ–æ ¸å¿ƒåº“å’Œæ›´æ–°æŽ§åˆ¶å™¨
        if Self.verbose {
            os_log("\(Self.t)åˆå§‹åŒ–åº”ç”¨...")
        }

        updaterController = SPUStandardUpdaterController(
            startingUpdater: true,
            updaterDelegate: nil,
            userDriverDelegate: nil
        )

        if Self.verbose {
            os_log("\(Self.t)åº”ç”¨åˆå§‹åŒ–å®Œæˆ")
        }
    }

    var body: some Scene {
        WindowGroup {
            ContentLayout()
                .environmentObject(appProvider)
                .environmentObject(pluginProvider)
        }
        .windowStyle(.titleBar)
        .modelContainer(AppConfig.getContainer())
        .commands {
            DebugCommand()
            SettingsCommand()
            ConfigCommand()
        }
    }
}

// MARK: - Action

extension CoreApp {
    /// èŽ·å–åº”ç”¨ä¿¡æ¯
    /// - Returns: åº”ç”¨ä¿¡æ¯å­—å…¸
    static func getAppInfo() -> [String: Any] {
        [
            "name": Bundle.main.object(forInfoDictionaryKey: "CFBundleName") as? String ?? "Unknown",
            "version": Bundle.main.object(forInfoDictionaryKey: "CFBundleShortVersionString") as? String ?? "1.0.0",
            "build": Bundle.main.object(forInfoDictionaryKey: "CFBundleVersion") as? String ?? "1",
        ]
    }
}

// MARK: - Preview

#Preview("App - Small Screen") {
    ContentLayout()
        .hideSidebar()
        .hideTabPicker()
        .inRootView()
        .frame(width: 800, height: 600)
}

#Preview("App - Big Screen") {
    ContentLayout()
        .hideSidebar()
        .hideTabPicker()
        .inRootView()
        .frame(width: 1200, height: 1200)
}
