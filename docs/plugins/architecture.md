# 插件系统架构图

## 系统概览

```text
┌─────────────────────────────────────────────────────────────────────┐
│                         应用程序                                      │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                     ContentView                               │   │
│  │  ┌────────────────────────────────────────────────────────┐  │   │
│  │  │                  Toolbar                                │  │   │
│  │  │  [ProjectPicker] [Git|Files|...] [Branch] [Actions]    │  │   │
│  │  └────────────────────────────────────────────────────────┘  │   │
│  │  ┌──────────────┬───────────────────────────────────────────┐  │   │
│  │  │              │                                           │  │   │
│  │  │   Sidebar    │            Detail View                    │  │   │
│  │  │              │                                           │  │   │
│  │  │ ┌──────────┐ │  ┌─────────────────────────────────────┐ │  │   │
│  │  │ │CommitList│ │  │                                     │ │  │   │
│  │  │ │          │ │  │         GitDetail                    │ │  │   │
│  │  │ │ Commit 1 │ │  │         CommitForm                   │ │  │   │
│  │  │ │ Commit 2 │ │  │         FileList                     │ │  │   │
│  │  │ │ Commit 3 │ │  │         FileDetail                   │ │  │   │
│  │  │ └──────────┘ │  └─────────────────────────────────────┘ │  │   │
│  │  │              │                                           │  │   │
│  │  └──────────────┴───────────────────────────────────────────┘  │   │
│  │  ┌────────────────────────────────────────────────────────┐  │   │
│  │  │                  StatusBar                              │  │   │
│  │  │  [Branch: main] [3 files changed] [↑2 ↓1]             │  │   │
│  │  └────────────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

## 插件注册流程

```text
┌─────────────┐
│ App Launch  │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│              PluginProvider.autoRegisterPlugins()           │
│                                                              │
│  通过 Objective-C Runtime 扫描所有类                         │
│  查找符合 PluginRegistrant 协议的类                          │
└──────┬──────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│                    每个插件的 register()                     │
└──────┬──────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│              PluginRegistry.register()                       │
│                                                              │
│  存储：FactoryItem {                                         │
│    id: String                                                │
│    order: Int                                                │
│    factory: () -> SuperPlugin                                │
│  }                                                           │
└──────┬──────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│              PluginRegistry.buildAll()                       │
│                                                              │
│  1. 按 order 排序                                            │
│  2. 调用每个 factory()                                       │
│  3. 返回 [SuperPlugin] 数组                                  │
└──────┬──────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│              PluginProvider 存储插件                         │
│                                                              │
│  @Published var plugins: [SuperPlugin]                       │
│  var tabPlugins: [SuperPlugin] { 筛选 isTab == true }       │
└─────────────────────────────────────────────────────────────┘
```

## 插件视图贡献

```text
┌──────────────────────────────────────────────────────────────┐
│                     SuperPlugin Protocol                     │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  视图方法                                            │    │
│  ├─────────────────────────────────────────────────────┤    │
│  │  addListView(tab, project) -> AnyView?              │    │
│  │  addDetailView() -> AnyView?                         │    │
│  │  addToolBarLeadingView() -> AnyView?                 │    │
│  │  addToolBarTrailingView() -> AnyView?                │    │
│  │  addStatusBarLeadingView() -> AnyView?               │    │
│  │  addStatusBarCenterView() -> AnyView?                │    │
│  │  addStatusBarTrailingView() -> AnyView?              │    │
│  └─────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────┘
                              │
                              │ 实现
                              ▼
┌──────────────────────────────────────────────────────────────┐
│                    具体插件实现                               │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  GitPlugin (order: 0, isTab: true)                  │    │
│  │  ├─ addDetailView() → GitDetail                     │    │
│  │  └─ addStatusBarLeadingView() → BranchStatus        │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  CommitPlugin (order: 23)                            │    │
│  │  └─ addListView() → CommitList (仅 Git tab)         │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  BranchPlugin (order: 22)                            │    │
│  │  └─ addToolBarTrailingView() → BranchPicker         │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  ProjectPickerPlugin (order: 24)                     │    │
│  │  └─ addToolBarLeadingView() → ProjectPicker         │    │
│  └─────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────┘
```

## UI 区域映射

```text
┌────────────────────────────────────────────────────────────────┐
│                        Toolbar                                 │
│  ┌──────────────────┐  ┌──────────────┐  ┌─────────────────┐ │
│  │  addToolBar      │  │    Tabs      │  │  addToolBar     │ │
│  │  LeadingView     │  │    (isTab)   │  │  TrailingView   │ │
│  │                  │  │              │  │                 │ │
│  │  [ProjectPicker] │  │  [Git|Files] │  │  [BranchPicker] │ │
│  └──────────────────┘  └──────────────┘  └─────────────────┘ │
└────────────────────────────────────────────────────────────────┘
        │                          │                   │
        │                          │                   │
        ▼                          ▼                   ▼
┌────────────────────────────────────────────────────────────────┐
│  ProjectPickerPlugin          GitPlugin               BranchPlugin│
│  .addToolBarLeadingView()    (isTab: true)          .addToolBar  │
│                              .addDetailView()       TrailingView()│
└────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────┐
│                        Content Area                             │
│  ┌─────────────────┐  ┌──────────────────────────────────────┐ │
│  │   Sidebar       │  │         Detail View                   │ │
│  │                 │  │                                      │ │
│  │  addListView    │  │  addDetailView                       │ │
│  │                 │  │                                      │ │
│  │  [CommitList]   │  │  [GitDetail / CommitForm / ...]      │ │
│  │                 │  │                                      │ │
│  └─────────────────┘  └──────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────┘
        │                                │
        ▼                                ▼
┌──────────────────────┐    ┌──────────────────────────────────────┐
│  CommitPlugin        │    │  GitPlugin                             │
│  .addListView()      │    │  .addDetailView()                      │
│  (仅 Git tab 显示)   │    │                                        │
└──────────────────────┘    └──────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────┐
│                        StatusBar                                │
│  ┌──────────────────┐  ┌──────────────┐  ┌─────────────────┐ │
│  │  addStatusBar    │  │  addStatus   │  │  addStatusBar   │ │
│  │  LeadingView     │  │  BarCenter   │  │  TrailingView   │ │
│  │                  │  │  View        │  │                 │ │
│  │  [Branch info]   │  │  [Files: 3]  │  │  [Sync status]  │ │
│  └──────────────────┘  └──────────────┘  └─────────────────┘ │
└────────────────────────────────────────────────────────────────┘
```

## 事件通信系统

```text
┌──────────────────────────────────────────────────────────────┐
│                    NotificationCenter                          │
│                                                              │
│  ┌────────────────────────────────────────────────────┐     │
│  │  系统事件                                           │     │
│  ├────────────────────────────────────────────────────┤     │
│  │  • appReady                                         │     │
│  │  • appDidBecomeActive                               │     │
│  │  • appWillBecomeActive                              │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│  ┌────────────────────────────────────────────────────┐     │
│  │  项目事件                                           │     │
│  ├────────────────────────────────────────────────────┤     │
│  │  • projectDidCommit                                 │     │
│  │  • projectDidPush                                   │     │
│  │  • projectDidPull                                   │     │
│  │  • projectDidChangeBranch                           │     │
│  │  • projectDidUpdateUserInfo                         │     │
│  └────────────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────────────┘
                         │
         ┌───────────────┼───────────────┐
         │               │               │
         ▼               ▼               ▼
┌────────────────┐ ┌────────────┐ ┌──────────────┐
│   Plugin A     │ │  Plugin B  │ │  Plugin C    │
│                │ │            │ │              │
│ .onReceive()   │ │ .onReceive()│ │ .onReceive() │
└────────────────┘ └────────────┘ └──────────────┘
```

## 插件加载顺序

```text
Order: 0    →  GitPlugin          (核心功能)
Order: 22   →  BranchPlugin       (分支管理)
Order: 23   →  CommitPlugin       (提交历史)
Order: 24   →  ProjectPickerPlugin (项目选择)
Order: 50+  →  其他插件            (扩展功能)
```

## 条件渲染逻辑

```text
addListView(tab: String, project: Project?) -> AnyView?
{
    if tab != "Git" { return nil }           // 标签页检查
    if project == nil { return nil }         // 项目存在检查
    if !project.isGitRepo { return nil }     // Git 仓库检查
    if !isPluginEnabled() { return nil }     // 插件启用检查

    return AnyView(MyListView())             // 返回视图
}
```

## 性能优化

```text
┌─────────────────────────────────────────────────────────────┐
│                     视图缓存机制                             │
│                                                              │
│  ContentView 缓存插件视图，避免重复创建                       │
│                                                              │
│  @State private var pluginListViews: [(plugin, view)]       │
│                                                              │
│  updateCachedViews() {                                       │
│      pluginListViews = plugins.compactMap { plugin in        │
│          guard let view = plugin.addListView(...) else       │
│              return nil                                      │
│          return (plugin, view)                               │
│      }                                                       │
│  }                                                           │
│                                                              │
│  触发时机：                                                  │
│  • 项目切换 (onChange(of: data.project))                    │
│  • 标签切换 (onChange(of: tab))                             │
│  • 插件加载 (onChange(of: plugins.count))                   │
└─────────────────────────────────────────────────────────────┘
```

## 类型安全保证

```text
┌─────────────────────────────────────────────────────────────┐
│                   编译时类型检查                             │
│                                                              │
│  protocol SuperPlugin {                                      │
│      static var label: String { get }                       │
│      func addListView(...) -> AnyView?                      │
│      ...                                                     │
│  }                                                           │
│                                                              │
│  ✅ 编译器检查：                                             │
│  • 所有必需属性是否实现                                      │
│  • 方法签名是否正确                                          │
│  • 返回类型是否匹配                                          │
│                                                              │
│  ❌ 编译错误示例：                                            │
│  • 缺少 label 属性                                           │
│  • addListView 返回类型错误                                  │
└─────────────────────────────────────────────────────────────┘
```

## 线程安全机制

```text
┌─────────────────────────────────────────────────────────────┐
│                    Actor 并发模型                            │
│                                                              │
│  actor PluginRegistry {                                      │
│      private var factoryItems: [FactoryItem]                │
│                                                              │
│      func register(...)    // 自动序列化访问                 │
│      func buildAll()       // 自动序列化访问                 │
│  }                                                           │
│                                                              │
│  ✅ 线程安全：                                               │
│  • 多个插件可同时注册                                        │
│  • Actor 保证串行执行                                        │
│  • 无需手动加锁                                              │
└─────────────────────────────────────────────────────────────┘
```
