# Motrix 下载管理插件方案（Lumi）

## 背景与目标
- 目标：在 Lumi 中以插件形式提供 Motrix 等价的下载管理能力（HTTP/HTTPS、FTP、BitTorrent、Magnet）。
- 策略：不嵌入 Motrix 的 Electron/Vue 前端；仅复用其核心下载引擎 aria2（RPC），实现原生 SwiftUI UI，统一设计与交互。
- 设计一致性：严格遵循 GlassCard 组件与 AppTheme 设计系统。

## 架构总览
- 技术栈：Swift/SwiftUI（UI 与插件框架）+ aria2c（下载引擎，RPC 控制）。
- 模块划分：
  - Models：任务与传输数据模型（DownloadTask、TorrentInfo、TransferStats）。
  - Services：下载引擎封装（Aria2Service）、Tracker 自动更新（TrackerService）、UPnP/NAT-PMP（PortMappingService）。
  - ViewModels：任务聚合状态、指令分发（DownloadManagerViewModel）。
  - Views：下载管理主界面、BT 文件选择器、设置页（GlassCard 风格）。
- 与工程对接：
  - 插件协议与注册：[SuperPlugin.swift](file:///Users/colorfy/Code/CofficLab/Lumi/LumiApp/Core/Contact/SuperPlugin.swift)、[PluginProvider.swift](file:///Users/colorfy/Code/CofficLab/Lumi/LumiApp/Core/Providers/PluginProvider.swift)
  - 设置页面集成：[PluginSettingsView.swift](file:///Users/colorfy/Code/CofficLab/Lumi/LumiApp/Core/Views/Settings/PluginSettingsView.swift)
  - 主题与样式：[AppTheme.swift](file:///Users/colorfy/Code/CofficLab/Lumi/LumiApp/Core/Theme/AppTheme.swift)、[GlassCard.swift](file:///Users/colorfy/Code/CofficLab/Lumi/LumiApp/Core/Views/Components/GlassCard.swift)
  - 状态栏/速度显示：[StatusBarController.swift](file:///Users/colorfy/Code/CofficLab/Lumi/LumiApp/Core/Controllers/StatusBarController.swift)、[NetworkManagerPlugin.swift](file:///Users/colorfy/Code/CofficLab/Lumi/LumiApp/Plugins/NetworkManagerPlugin/NetworkManagerPlugin.swift)
  - 任务与事件：[TaskService.swift](file:///Users/colorfy/Code/CofficLab/Lumi/LumiApp/Core/Services/TaskService.swift)、[AppEvents.swift](file:///Users/colorfy/Code/CofficLab/Lumi/LumiApp/Core/Events/AppEvents.swift)
  - 设置存储：[PluginSettingsStore.swift](file:///Users/colorfy/Code/CofficLab/Lumi/LumiApp/Core/Providers/PluginSettingsStore.swift)

## 能力映射（Motrix → 插件）
- 下载协议：HTTP/HTTPS、FTP、BT、Magnet。
- BT 选择性下载：展示 .torrent 文件树，选择文件与优先级。
- Tracker 列表每日自动更新：失败回退至本地缓存。
- 并发与线程：最多 10 并发任务；单任务最多 64 线程（aria2 `split`）。
- 速度限制：全局/单任务限速；状态栏实时速度表。
- Mock UA：可设置默认 User-Agent。
- 通知：任务完成系统通知；可选“删除相关文件”。
- 深色模式与 I18n：遵循 AppTheme 与 xcstrings。

## 接口规范（函数级说明约定）
> 以下为接口约定说明，实际实现采用 Swift，并在函数级添加注释（用途、参数、返回、错误）。

- Aria2Service
  - 启动/停止 RPC 服务（指定端口、工作目录、会话文件）。
  - 任务控制：新增（URL/Magnet/torrent 文件）、暂停、继续、移除、设置限速、设置 UA。
  - 事件订阅：进度、速度、状态变更、完成/错误回调。
- TrackerService
  - 每日拉取公共 Tracker 列表；校验与去重；写入 aria2。
  - 本地缓存与失败回退机制。
- PortMappingService
  - UPnP/NAT-PMP 端口映射（BT 端口优先）；失败提示与回退策略。
- DownloadManagerViewModel
  - 聚合任务状态、调度服务调用、提供 UI 绑定数据。
- 插件入口（MotrixDownloadPlugin）
  - 插件元信息（名称/图标/入口视图）、设置视图与状态栏集成。

## 配置项（通过 PluginSettingsStore 持久化）
- downloadDirectory（下载目录，默认 ~/Downloads/Lumi）
- maxConcurrentTasks（默认 5，最大 10）
- defaultUserAgent（默认空，继承系统 UA）
- enableTrackerAutoUpdate（默认开启）
- speedLimitGlobal（默认 0 不限速）
- aria2RpcPort（默认 6800）
- enablePortMapping（默认关闭）

## UI 规范（GlassCard + AppTheme）
- 统一使用 GlassCard 布局任务列表与卡片，背景使用 `.ultraThinMaterial`。
- 列表项状态行：名称、进度条、速度/ETA、线程数、操作按钮（暂停/继续/限速/移除）。
- 详情抽屉：错误信息、连接统计、文件列表。
- 设置页：分组卡片形式展示下载目录、并发/线程、UA、Tracker、端口映射等。
- 状态栏：展示全局下载速度，点击弹出最近任务的卡片列表。

## 二进制与权限
- 内置 `aria2c`（含 Apple Silicon），首次运行生成 `aria2.session`。
- Entitlements：网络访问、下载目录文件访问；参考 [App.entitlements](file:///Users/colorfy/Code/CofficLab/Lumi/LumiApp/App.entitlements)。
- 资源打包：`aria2c` 与默认 Tracker 列表置于 Assets，并在 Build Phases 拷贝至可写目录。

## 开发步骤与里程碑
1. 初始化（当前阶段）
   - 创建插件目录 `LumiApp/Plugins/MotrixDownloadPlugin/`
   - 编写本方案文件 `方案.md`
2. 接口层
   - 定义 `Aria2Service`、`DownloadManagerViewModel`、模型与事件通道
3. 基础功能
   - HTTP/FTP 下载、任务列表与控制、完成通知
4. BT/Magnet 支持
   - 磁力与 .torrent 导入、文件选择、Tracker 自动更新
5. 状态栏与速度显示
   - 全局速度汇总、弹出视图最近任务
6. 端口映射与高级设置
   - UPnP/NAT-PMP、UA/限速策略、并发/线程参数
7. 打包与签名
   - 资源与权限校验、发布前测试

## 测试与验证
- 单元测试：`Aria2Service`（RPC 与任务控制）、`TrackerService`（更新/回退）、`PortMappingService`（成功/失败路径）。
- 集成测试：新增→下载→完成全流程、BT 文件选择与优先级、限速与并发策略。
- UI 预览：SwiftUI Preview 验证暗/亮主题与 GlassCard 风格一致性。

## 风险与回退
- 风险：沙箱权限与可写路径、UPnP/NAT-PMP 在部分网络不可用、BT 合规要求。
- 回退：开发阶段可依赖本机 `brew install aria2`；提供“外部 aria2 路径”设置；端口映射失败提示用户手动配置。

## 资源清单
- 二进制：`aria2c`（Apple Silicon）、默认 `trackers.txt`
- 可写文件：`aria2.session`、下载目录、任务元数据缓存（JSON）

## 目录结构（建议）
```
LumiApp/Plugins/MotrixDownloadPlugin/
  ├─ MotrixDownloadPlugin.swift        // 插件入口（后续开发）
  ├─ MotrixDownload.xcstrings          // 本地化（后续开发）
  ├─ Models/
  │   ├─ DownloadTask.swift            // 任务模型（后续开发）
  │   └─ TorrentInfo.swift             // BT 文件信息（后续开发）
  ├─ Services/
  │   ├─ Aria2Service.swift            // RPC 封装（后续开发）
  │   ├─ TrackerService.swift          // Tracker 更新（后续开发）
  │   └─ PortMappingService.swift      // UPnP/NAT-PMP（后续开发）
  ├─ ViewModels/
  │   └─ DownloadManagerViewModel.swift// 视图模型（后续开发）
  ├─ Views/
  │   ├─ DownloadManagerView.swift     // 主视图（后续开发）
  │   ├─ TorrentFilesPickerView.swift  // 文件选择（后续开发）
  │   └─ SettingView.swift             // 设置（后续开发）
  ├─ Assets/
  │   ├─ aria2c                        // 下载引擎二进制（后续集成）
  │   └─ trackers.txt                  // 默认 Tracker 列表（后续集成）
  └─ 方案.md                           // 本方案文件
```

## 交付标准
- 接口文档与函数级注释完整；UI 遵循 GlassCard 与 AppTheme。
- 支持上述协议与能力映射；含 Tracker 自动更新与可选端口映射。
- 单元/集成测试覆盖核心路径；状态栏速度显示与完成通知稳定。

## 开发提示
- 本机调试可先安装：`brew install aria2`；RPC 默认端口 6800。
- Apple Silicon 打包注意 codesign；沙箱访问下载目录需显式权限。

