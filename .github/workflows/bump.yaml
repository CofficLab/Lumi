name: Bump

on:
  push:
    branches:
      - pre
      - main

permissions:
  contents: write

env:
  tag: ${{ github.event.head_commit.id }}

jobs:
  bump:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      - name: Calculate Next Version
        id: version
        run: |
          chmod +x .github/scripts/bump-version.sh
          chmod +x .github/scripts/calculate-version.sh

          # è·å–å½“å‰ç‰ˆæœ¬
          LAST_TAG=$(git describe --tags --match "v*" --abbrev=0 2>/dev/null || echo "v0.0.0")
          LAST_TAG="${LAST_TAG#v}"

          # è®¡ç®—æ–°ç‰ˆæœ¬
          NEW_VERSION=$(.github/scripts/calculate-version.sh)
          echo "new_version=$NEW_VERSION" >> $GITHUB_ENV
          echo "New Version: $NEW_VERSION"

          # è¾“å‡ºåˆ° Summary
          echo "## ğŸ“Š ç‰ˆæœ¬è®¡ç®—" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¸Šä¸€ä¸ªç‰ˆæœ¬**: \`$LAST_TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "- **æ–°ç‰ˆæœ¬**: \`$NEW_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
      - name: Update Xcode Project Version
        run: |
          # è¯»å–æ›´æ–°å‰çš„ç‰ˆæœ¬
          OLD_MARKETING_VERSION=$(agvtool what-marketing-version -terse)

          # æ›´æ–° MARKETING_VERSION
          # 1. å°è¯•ä½¿ç”¨ agvtool æ›´æ–°æ‰€æœ‰ target (æ³¨æ„ï¼šnew-marketing-version ä¸æ”¯æŒ -all å‚æ•°)
          agvtool new-marketing-version ${{ env.new_version }}

          # 2. å¼ºåˆ¶ä½¿ç”¨ sed æ›´æ–°æ‰€æœ‰ target çš„ MARKETING_VERSION é…ç½®ï¼Œä½œä¸ºåŒé‡ä¿é™©
          # è¿™ç¡®ä¿äº†å³ä½¿ agvtool é—æ¼äº†æŸäº› targetï¼Œå®ƒä»¬ä¹Ÿä¼šè¢«æ›´æ–°
          sed -i '' "s/MARKETING_VERSION = [^;]*/MARKETING_VERSION = ${{ env.new_version }}/" Lumi.xcodeproj/project.pbxproj

          # éªŒè¯æ›´æ–°
          NEW_MARKETING_VERSION=$(agvtool what-marketing-version -terse)

          echo "## ğŸ“ MARKETING_VERSION æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| æ›´æ–°å‰ | \`$OLD_MARKETING_VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| æ›´æ–°å | \`$NEW_MARKETING_VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| é¢„æœŸå€¼ | \`${{ env.new_version }}\` |" >> $GITHUB_STEP_SUMMARY

          # æ£€æŸ¥æ˜¯å¦æ›´æ–°æˆåŠŸ
          if [ "$NEW_MARKETING_VERSION" != "${{ env.new_version }}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **è­¦å‘Š**: agvtool æ˜¾ç¤ºçš„ç‰ˆæœ¬å¯èƒ½ä¸åŒ¹é…ï¼Œä½† sed åº”è¯¥å·²ç»å¼ºåˆ¶æ›´æ–°äº†æ–‡ä»¶ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
      - name: æ›´æ–°æ„å»ºå·
        run: |
          # è¯»å–æ›´æ–°å‰çš„æ„å»ºå·
          OLD_BUILD_VERSION=$(agvtool what-version -terse)

          # æ›´æ–° CURRENT_PROJECT_VERSION
          agvtool next-version -all

          # è·å–æ–°çš„æ„å»ºå·å¹¶å¼ºåˆ¶åŒæ­¥
          NEW_BUILD_VERSION=$(agvtool what-version -terse)
          
          # å¼ºåˆ¶ä½¿ç”¨ sed åŒæ­¥æ‰€æœ‰ target çš„ CURRENT_PROJECT_VERSION
          # è¿™ç¡®ä¿äº†æ‰€æœ‰ target çš„æ„å»ºå·éƒ½ä¸ä¸» target ä¸€è‡´
          sed -i '' "s/CURRENT_PROJECT_VERSION = [^;]*/CURRENT_PROJECT_VERSION = $NEW_BUILD_VERSION/" Lumi.xcodeproj/project.pbxproj

          echo "## ğŸ”¢ CURRENT_PROJECT_VERSION æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| æ›´æ–°å‰ | \`$OLD_BUILD_VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| æ›´æ–°å | \`$NEW_BUILD_VERSION\` |" >> $GITHUB_STEP_SUMMARY
      - name: ç”Ÿæˆæ ‡ç­¾ï¼ˆpre åˆ†æ”¯ï¼‰
        if: github.ref == 'refs/heads/pre'
        run: |
          build=$(agvtool what-version -terse)
          echo "tag=p${{ env.new_version }}($build)" >> $GITHUB_ENV

          echo "## ğŸ·ï¸ ç”Ÿæˆæ ‡ç­¾ï¼ˆPre-releaseï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ ‡ç­¾**: \`p${{ env.new_version }}($build)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: \`${{ env.new_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **æ„å»ºå·**: \`$build\`" >> $GITHUB_STEP_SUMMARY
      - name: ç”Ÿæˆæ ‡ç­¾ï¼ˆmain åˆ†æ”¯ï¼‰
        if: github.ref == 'refs/heads/main'
        run: |
          echo "tag=v${{ env.new_version }}" >> $GITHUB_ENV

          echo "## ğŸ·ï¸ ç”Ÿæˆæ ‡ç­¾ï¼ˆReleaseï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ ‡ç­¾**: \`v${{ env.new_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: \`${{ env.new_version }}\`" >> $GITHUB_STEP_SUMMARY
      - name: æ‰“æ ‡ç­¾å¹¶æ¨é€åˆ°ä»“åº“
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ci: bump to ${{ env.new_version }}"
          commit_user_name: GitHub Action
          tagging_message: ${{ env.tag }}
          push_options: "--tags"
          branch: ${{ github.ref_name }}

      - name: è¾“å‡ºæœ€ç»ˆæ‘˜è¦
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… ç‰ˆæœ¬ Bump å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| æ–°ç‰ˆæœ¬ | \`${{ env.new_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Git æ ‡ç­¾ | \`${{ env.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| æ„å»ºå· | \`$(agvtool what-version -terse)\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Marketing Version | \`$(agvtool what-marketing-version -terse)\` |" >> $GITHUB_STEP_SUMMARY

  rebase:
    if: github.ref == 'refs/heads/main'
    needs:
      - bump
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å– main åˆ†æ”¯
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      - name: æ£€æŸ¥ pre åˆ†æ”¯æ˜¯å¦å­˜åœ¨
        id: check_pre
        run: |
          if git ls-remote --heads origin pre | grep -q pre; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      - name: æ‹‰å– pre åˆ†æ”¯
        if: steps.check_pre.outputs.exists == 'true'
        run: git fetch origin pre
      - name: Rebase pre on main
        continue-on-error: true
        if: steps.check_pre.outputs.exists == 'true'
        run: git rebase origin/main
      - name: Push the rebased pre branch
        continue-on-error: true
        if: steps.check_pre.outputs.exists == 'true'
        run: git push origin pre
