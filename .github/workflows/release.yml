name: Release

on:
  workflow_run:
    workflows:
      - "Bump"
    types:
      - completed

permissions:
  contents: write

env:
  TAG: ${{ github.sha }}
  SCHEME: Lumi
  REPO_LINK: "https://github.com/CofficLab/Lumi"
  DESTINATION: "generic/platform=macOS"
  ENTITLEMENTS_PATH: "LumiApp/App.entitlements" # ‰∏ª App ÊùÉÈôêÊñá‰ª∂Ë∑ØÂæÑ
  ArchivePath: "./my-app"
  BuildPath: "./temp"
  IS_PRERELEASE: true
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
  BUILD_CERTIFICATE_P12_PASSWORD: ${{ secrets.BUILD_CERTIFICATE_P12_PASSWORD }}
  APP_STORE_CONNECT_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_KEY_BASE64 }}
  APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
  APP_STORE_CONNECT_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ISSER_ID }}
  SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY_GITOK }}

jobs:
  build_with_signing:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: macos-15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_branch }}
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "latest-stable"
      - name: Verify Xcode version
        run: |
          echo "Current Xcode version:"
          xcodebuild -version
          echo "Swift version:"
          xcrun swift --version
          echo "Xcode path:"
          xcode-select -p
      - name: Ëé∑ÂèñÊúÄÊñ∞ tag
        id: get_tag
        run: |
          tag=$(git describe --tags --abbrev=0)
          echo "TAG=$tag" >> $GITHUB_ENV
          if [[ $tag == p* ]]; then
            echo "IS_PRERELEASE=true" >> $GITHUB_ENV
          else
            echo "IS_PRERELEASE=false" >> $GITHUB_ENV
          fi

          # ËæìÂá∫Âà∞ Summary
          echo "## üè∑Ô∏è ÁâàÊú¨Ê†áÁ≠æ‰ø°ÊÅØ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: \`$tag\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Is Prerelease**: \`${{ env.IS_PRERELEASE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.event.workflow_run.head_branch }}\`" >> $GITHUB_STEP_SUMMARY
      - name: Setup macOS signing
        id: signing
        run: |
          chmod +x ./.github/scripts/setup-macos-signing.sh
          source ./.github/scripts/setup-macos-signing.sh
          echo "signing_identity=$SIGNING_IDENTITY" >> $GITHUB_OUTPUT
          echo "team_id=$TEAM_ID" >> $GITHUB_OUTPUT
          echo "api_key_path=$API_KEY_PATH" >> $GITHUB_OUTPUT
      - name: Build App
        run: |
          # ËØªÂèñ Xcode È°πÁõÆÁâàÊú¨
          MARKETING_VERSION=$(xcodebuild -project ${{ env.SCHEME }}.xcodeproj -showBuildSettings | grep MARKETING_VERSION | awk '{print $3}')
          CURRENT_VERSION=$(xcodebuild -project ${{ env.SCHEME }}.xcodeproj -showBuildSettings | grep CURRENT_PROJECT_VERSION | awk '{print $3}')

          echo "## üì¶ ÊûÑÂª∫ÁâàÊú¨‰ø°ÊÅØ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **MARKETING_VERSION**: \`$MARKETING_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- **CURRENT_PROJECT_VERSION**: \`$CURRENT_VERSION\`" >> $GITHUB_STEP_SUMMARY

          # ‰ΩøÁî® xcodebuild archive ÊûÑÂª∫ÔºåÁ°Æ‰øù‰∫ßÁâ©ÊòØ Release ÁâàÊú¨‰∏îÂéªÈô§‰∫ÜË∞ÉËØïÁ¨¶Âè∑
          xcodebuild archive \
            -scheme ${{ env.SCHEME }} \
            -archivePath ./temp/${{ env.SCHEME }}.xcarchive \
            -configuration Release \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="-" \
            DEVELOPMENT_TEAM="${{ steps.signing.outputs.team_id }}" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            CODE_SIGNING_REQUIRED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=YES

      - name: Codesign App
        run: |
          # ‰ªé xcarchive ‰∏≠ÊèêÂèñ App
          cp -r "./temp/${{ env.SCHEME }}.xcarchive/Products/Applications/${{ env.SCHEME }}.app" "./temp/${{ env.SCHEME }}.app"
          APP_PATH="./temp/${{ env.SCHEME }}.app"
          IDENTITY="${{ steps.signing.outputs.signing_identity }}"
          
          echo "Signing Frameworks..."
          if [ -d "$APP_PATH/Contents/Frameworks" ]; then
             # ÂÖàÁ≠æ dylib
             find "$APP_PATH/Contents/Frameworks" -type f -name "*.dylib" -exec codesign --force --verbose --sign "$IDENTITY" --options runtime {} \; || true
             
             # ÁâπÊÆäÂ§ÑÁêÜ Sparkle Á≠âÂåÖÂê´ÂµåÂ•ó App ÁöÑ Framework
             find "$APP_PATH/Contents/Frameworks" -type d -name "*.app" -exec codesign --force --verbose --sign "$IDENTITY" --options runtime {} \; || true
             
             # ÂÜçÁ≠æ framework (ÂåÖÂê´ÈáåÈù¢ÁöÑ dylib Âíå app)
             find "$APP_PATH/Contents/Frameworks" -type d -name "*.framework" -exec codesign --force --verbose --sign "$IDENTITY" --options runtime {} \; || true
          fi

          echo "Signing Extensions..."
          if [ -d "$APP_PATH/Contents/PlugIns" ]; then
            # ÈÄíÂΩíÁ≠æÂêç ExtensionÔºåÊòæÂºèÂ§çÁî®‰∏ª App ÁöÑ Entitlements (‰∏ªË¶ÅÊòØ App Groups)
            # Ê≥®ÊÑèÔºöÂ¶ÇÊûú Extension ÈúÄË¶ÅÊ≤ôÁõí‰ΩÜ‰∏ª App ‰∏çÈúÄË¶ÅÔºåËøôÈáåÂèØËÉΩÈúÄË¶ÅÂå∫ÂàÜ„ÄÇÁõÆÂâçÂÅáËÆæ‰∏ÄËá¥ÊàñÂÖºÂÆπ„ÄÇ
            find "$APP_PATH/Contents/PlugIns" -name "*.appex" -exec codesign --force --verbose --sign "$IDENTITY" --options runtime --entitlements "${{ env.ENTITLEMENTS_PATH }}" {} \;
          fi

          echo "Signing Main App..."
          # ‰∏ª App ÂøÖÈ°ªÂ∏¶ Entitlements (App Groups Á≠âÊùÉÈôê)
          codesign --force --verbose --sign "$IDENTITY" --options runtime --entitlements "${{ env.ENTITLEMENTS_PATH }}" "$APP_PATH"

      - name: Create DMG
        run: |
          # ÂáÜÂ§á DMG ÂÜÖÂÆπÊöÇÂ≠òÁõÆÂΩï
          # ‰ΩøÁî®ÊöÇÂ≠òÁõÆÂΩïÂèØ‰ª•ÈÅøÂÖç hdiutil Áõ¥Êé•Â§ÑÁêÜ /Applications ËΩØÈìæÊé•Êó∂ÁöÑÈÅçÂéÜÈóÆÈ¢òÔºåÊèêÈ´òÊâìÂåÖÈÄüÂ∫¶
          STAGING_DIR="./temp/dmg_staging"
          mkdir -p "$STAGING_DIR"
          
          # Â§çÂà∂ App Âà∞ÊöÇÂ≠òÁõÆÂΩï
          cp -r "./temp/${{ env.SCHEME }}.app" "$STAGING_DIR/"
          
          # Âú®ÊöÇÂ≠òÁõÆÂΩï‰∏≠ÂàõÂª∫ÊåáÂêë /Applications ÁöÑËΩØÈìæÊé•
          ln -s /Applications "$STAGING_DIR/Applications"
          
          VOL_NAME="${{ env.SCHEME }}"
          DMG_NAME="./temp/${{ env.SCHEME }}.dmg"

          # ÂØπÊöÇÂ≠òÁõÆÂΩïËøõË°åÊâìÂåÖ
          hdiutil create -volname "$VOL_NAME" -srcfolder "$STAGING_DIR" -ov -format UDZO "$DMG_NAME"

          # Êü•ÊâæÁîüÊàêÁöÑ DMG Êñá‰ª∂
          dmg_file=$(find ./temp -name "*.dmg" -type f | head -n 1)
          if [ -n "$dmg_file" ]; then
            dmg_basename=$(basename "$dmg_file")
            echo "## üíø DMG Êñá‰ª∂‰ø°ÊÅØ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Êñá‰ª∂Âêç**: \`$dmg_basename\`" >> $GITHUB_STEP_SUMMARY
            ls -lh "$dmg_file" | awk '{print "- **Êñá‰ª∂Â§ßÂ∞è**: " $5}' >> $GITHUB_STEP_SUMMARY
          fi
      - name: Notary
        continue-on-error: true
        run: |
          file=$(find . -maxdepth 2 -type f -name "*.dmg" | head -n 1)
          xcrun notarytool submit "$file" \
            --key ${{ steps.signing.outputs.api_key_path }} \
            --key-id=${{ env.APP_STORE_CONNECT_KEY_ID }} \
            --issuer ${{ env.APP_STORE_CONNECT_KEY_ISSUER_ID }} \
            --wait \
            --timeout 10m
          stapler staple "$file"
      - name: ÂÖ¨ËØÅÁªìÊûú
        continue-on-error: true
        run: |
          file=$(find . -maxdepth 2 -type f -name "*.dmg" | head -n 1)
          stapler validate "$file"
      - name: Check
        run: |
          ls -alh
          mkdir updates
          cp ./temp/*.dmg updates/
          echo "the updates is in ${{ github.workspace }}/updates"
          ls -alh updates
      - name: generate appcast (production only)
        if: env.IS_PRERELEASE == 'false'
        continue-on-error: true
        run: |
          xcodebuild -resolvePackageDependencies
          cd $(ls -d ~/Library/Developer/Xcode/DerivedData/${{ env.SCHEME }}*/ | head -n 1)
          cd SourcePackages/artifacts/sparkle/Sparkle/bin
          echo "${{ env.SPARKLE_PRIVATE_KEY }}" | ./generate_appcast --ed-key-file - ${{ github.workspace }}/updates

          # ËæìÂá∫ appcast.xml ‰∏≠ÁöÑÁâàÊú¨‰ø°ÊÅØ
          cd ${{ github.workspace }}/updates
          if [ -f appcast.xml ]; then
            APPCAST_VERSION=$(xmllint --xpath "string(//rss/channel/item/sparkle:shortVersionString)" appcast.xml 2>/dev/null || echo "Êú™Áü•")
            APPCAST_BUILD=$(xmllint --xpath "string(//rss/channel/item/sparkle:version)" appcast.xml 2>/dev/null || echo "Êú™Áü•")

            echo "## üì° Appcast ‰ø°ÊÅØ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Appcast ÁâàÊú¨**: \`$APPCAST_VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Appcast Build**: \`$APPCAST_BUILD\`" >> $GITHUB_STEP_SUMMARY
          fi
      - name: make appcast.xml (production only)
        if: env.IS_PRERELEASE == 'false'
        run: |
          cd updates
          dmg_file=$(ls *.dmg 2>/dev/null | head -n 1)
          echo $dmg_file
          u="${{ env.REPO_LINK }}/releases/latest/download/$dmg_file" 
          echo $u
          sed -i '' "s|\(enclosure url=\"\)[^\"]*|\1$u|" "appcast.xml"
          mv appcast.xml ../appcast.xml
      - name: Generate Changelog
        run: |
          CURRENT_TAG=${{ env.TAG }}
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            NOTES="## Release $CURRENT_TAG\n\nInitial release"
          else
            NOTES="## Release $CURRENT_TAG\n\n### Changes since $PREVIOUS_TAG\n"
            NOTES="$NOTES\n$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --no-merges --pretty=format:'- %s' | sort | uniq | head -20)"
          fi
          echo -e "$NOTES" > changelog.md
          echo "### üìã Release Notes" >> $GITHUB_STEP_SUMMARY
          echo -e "$NOTES" >> $GITHUB_STEP_SUMMARY

          # ÁâàÊú¨ÂØπÊØîÊÄªÁªì
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîç ÁâàÊú¨‰∏ÄËá¥ÊÄßÊ£ÄÊü•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| È°πÁõÆ | ÂÄº |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Git Tag | \`${{ env.TAG }}\` |" >> $GITHUB_STEP_SUMMARY

          # Â¶ÇÊûúËÉΩËØªÂèñÂà∞ÊûÑÂª∫Êó∂ÁöÑÁâàÊú¨‰ø°ÊÅØÔºåÂàôÊ∑ªÂä†ÂØπÊØî
          if [ -n "$MARKETING_VERSION" ]; then
            echo "| Xcode MARKETING_VERSION | \`$MARKETING_VERSION\` |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "$CURRENT_VERSION" ]; then
            echo "| Xcode CURRENT_PROJECT_VERSION | \`$CURRENT_VERSION\` |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "$dmg_basename" ]; then
            echo "| DMG Êñá‰ª∂Âêç‰∏≠ÁöÑÁâàÊú¨ | \`$(echo $dmg_basename | grep -o '[0-9_]\+' | head -1 | tr '_' '.')\` |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f updates/appcast.xml ]; then
            APPCAST_VERSION=$(xmllint --xpath "string(//rss/channel/item/sparkle:shortVersionString)" updates/appcast.xml 2>/dev/null || echo "Êú™Áü•")
            echo "| Appcast ÁâàÊú¨ | \`$APPCAST_VERSION\` |" >> $GITHUB_STEP_SUMMARY
          fi
      - name: ÂèëÂ∏É Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          prerelease: ${{ env.IS_PRERELEASE }}
          body_path: changelog.md
          files: |
            ./updates/*.dmg
            ./appcast.xml
      - name: Êé®ÈÄÅÂà∞‰ªìÂ∫ì (pro)
        if: env.IS_PRERELEASE == 'false'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ci: update appcast.yml"
          commit_user_name: GitHub Action
          file_pattern: "appcast.xml"
