name: Release
on:
  workflow_run:
    workflows:
      - "Bump"
    types:
      - completed

jobs:
  build_with_signing:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: macos-15
    permissions:
      contents: write
    env:
      TAG: ${{ github.sha }}
      SCHEME: Lumi
      DESTINATION: "generic/platform=macOS"
      ArchivePath: "./build/Lumi.xcarchive"
      BuildPath: "./build"
      IS_PRERELEASE: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_branch }}
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "latest-stable"
      - uses: jozefizso/setup-sparkle@v2
        with:
          version: 2.8.1
      - name: Verify Xcode version
        run: |
          echo "Current Xcode version:"
          xcodebuild -version
          echo "Swift version:"
          xcrun swift --version
          echo "Xcode path:"
          xcode-select -p
      - name: Ëé∑ÂèñÊúÄÊñ∞ tag
        id: get_tag
        run: |
          tag=$(git describe --tags --abbrev=0)
          echo "TAG=$tag" >> $GITHUB_ENV
          if [[ $tag == p* ]]; then
            echo "IS_PRERELEASE=true" >> $GITHUB_ENV
          else
            echo "IS_PRERELEASE=false" >> $GITHUB_ENV
          fi
      - name: Setup macOS signing
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.MACOS_CERTIFICATE }}
          p12-password: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
      - name: Build App
        run: xcodebuild -project Lumi.xcodeproj -scheme ${{ env.SCHEME }} -configuration Release -archivePath ${{ env.ArchivePath }} archive CODE_SIGN_STYLE=Manual DEVELOPMENT_TEAM=${{ secrets.MACOS_TEAM_ID }} CODE_SIGN_IDENTITY="Developer ID Application" OTHER_CODE_SIGN_FLAGS="--options runtime" SPARKLE_PUBLIC_KEY="${{ secrets.SPARKLE_PUBLIC_KEY }}"
      - name: Export app
        run: |
          cat > exportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>developer-id</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>teamID</key>
            <string>${{ secrets.MACOS_TEAM_ID }}</string>
          </dict>
          </plist>
          EOF
          xcodebuild -exportArchive -archivePath ${{ env.ArchivePath }} -exportOptionsPlist exportOptions.plist -exportPath build/export
      - name: Create DMG
        run: |
          hdiutil create -volname "${{ env.SCHEME }}" -srcfolder "build/export/${{ env.SCHEME }}.app" -ov -format UDZO "build/${{ env.SCHEME }}.dmg"
      - name: Notary
        continue-on-error: true
        run: |
          xcrun notarytool submit "build/${{ env.SCHEME }}.dmg" \
            --apple-id "${{ secrets.APPLE_ID }}" \
            --password "${{ secrets.APPLE_ID_PASSWORD }}" \
            --team-id "${{ secrets.MACOS_TEAM_ID }}" \
            --wait \
            --timeout 10m
          stapler staple "build/${{ env.SCHEME }}.dmg"
      - name: ÂÖ¨ËØÅÁªìÊûú
        continue-on-error: true
        run: |
          stapler validate "build/${{ env.SCHEME }}.dmg"
      - name: Check
        run: |
          ls -alh build
          mkdir -p updates
          cp build/${{ env.SCHEME }}.dmg updates/
          echo "the updates is in ${{ github.workspace }}/updates"
          ls -alh updates
      - name: generate appcast (production only)
        if: env.IS_PRERELEASE == 'false'
        continue-on-error: true
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          echo "$SPARKLE_PRIVATE_KEY" | generate_appcast --ed-key-file - ${{ github.workspace }}/updates
      - name: make appcast.xml (production only)
        if: env.IS_PRERELEASE == 'false'
        run: |
          dmg_file=$(ls updates/*.dmg 2>/dev/null | head -n 1 | xargs -n 1 basename)
          u="https://github.com/${{ github.repository }}/releases/latest/download/$dmg_file"
          sed -i '' "s|\(enclosure url=\"\)[^\"]*|\1$u|" "updates/appcast.xml"
          mv updates/appcast.xml ./appcast.xml
      - name: ÂèëÂ∏É Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          prerelease: ${{ env.IS_PRERELEASE }}
          files: |
            ./updates/*.dmg
            ./appcast.xml
      - name: Êé®ÈÄÅÂà∞‰ªìÂ∫ì (pro)
        if: env.IS_PRERELEASE == 'false'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "üë∑ CI: update appcast.yml"
          commit_user_name: GitHub Action
          file_pattern: "appcast.xml"
