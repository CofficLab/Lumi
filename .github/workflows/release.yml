name: Release

on:
  push:
    branches:
      - pre
      - main

permissions:
  contents: write

env:
  # åŸºç¡€çŽ¯å¢ƒå˜é‡
  SCHEME: Lumi
  REPO_LINK: 'https://github.com/CofficLab/Lumi'
  DESTINATION: 'generic/platform=macOS'
  ENTITLEMENTS_PATH: 'LumiApp/App.entitlements'
  ArchivePath: './my-app'
  BuildPath: './temp'

  # Secrets
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
  BUILD_CERTIFICATE_P12_PASSWORD: ${{ secrets.BUILD_CERTIFICATE_P12_PASSWORD }}
  APP_STORE_CONNECT_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_KEY_BASE64 }}
  APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
  APP_STORE_CONNECT_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ISSER_ID }}
  SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY_GITOK }}

jobs:
  release_pipeline:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      # =================================================================================================
      # 1. ç‰ˆæœ¬è®¡ç®—ä¸Žé¡¹ç›®æ›´æ–°
      # =================================================================================================
      - name: Calculate Next Version
        id: version
        run: |
          chmod +x .github/scripts/bump-version.sh
          chmod +x .github/scripts/calculate-version.sh

          # èŽ·å–å½“å‰ç‰ˆæœ¬ (ä»…ç”¨äºŽæ˜¾ç¤º)
          LAST_TAG=$(git tag -l "v*" | sort -V | tail -n 1 2>/dev/null || echo "v0.0.0")
          LAST_TAG="${LAST_TAG#v}"

          # è®¡ç®—æ–°ç‰ˆæœ¬
          NEW_VERSION=$(.github/scripts/calculate-version.sh)
          echo "new_version=$NEW_VERSION" >> $GITHUB_ENV

          # ä¿å­˜ä¸Šä¸€ä¸ªæ ‡ç­¾ä¾› changelog ç”Ÿæˆä½¿ç”¨
          echo "previous_tag=$LAST_TAG" >> $GITHUB_ENV

          # è¾“å‡ºæ‘˜è¦
          echo "## ðŸ“Š ç‰ˆæœ¬è®¡ç®—" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¸Šä¸€ä¸ªç‰ˆæœ¬**: \`$LAST_TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "- **æ–°ç‰ˆæœ¬**: \`$NEW_VERSION\`" >> $GITHUB_STEP_SUMMARY

      - name: Update Xcode Project Version
        run: |
          # æ›´æ–° MARKETING_VERSION
          agvtool new-marketing-version ${{ env.new_version }} 2>/dev/null || true
          # å¼ºåˆ¶ä½¿ç”¨ sed æ›´æ–°æ‰€æœ‰ target çš„ MARKETING_VERSION é…ç½®
          sed -i '' "s/MARKETING_VERSION = [^;]*/MARKETING_VERSION = ${{ env.new_version }}/" Lumi.xcodeproj/project.pbxproj

          # éªŒè¯ï¼ˆä½¿ç”¨ xcodebuild è€Œéž agvtoolï¼‰
          NEW_MARKETING_VERSION=$(xcodebuild -project ${{ env.SCHEME }}.xcodeproj -showBuildSettings 2>/dev/null | grep -E "MARKETING_VERSION" | grep -v "CURRENT" | head -1 | awk -F'= ' '{print $2}')
          echo "Updated Marketing Version: $NEW_MARKETING_VERSION"

      - name: Update Build Number
        run: |
          # æ›´æ–° CURRENT_PROJECT_VERSION
          agvtool next-version -all 2>/dev/null || true
          NEW_BUILD_VERSION=$(xcodebuild -project ${{ env.SCHEME }}.xcodeproj -showBuildSettings 2>/dev/null | grep "CURRENT_PROJECT_VERSION" | awk '{print $3}')

          # å¼ºåˆ¶ä½¿ç”¨ sed åŒæ­¥æ‰€æœ‰ target çš„ CURRENT_PROJECT_VERSION
          sed -i '' "s/CURRENT_PROJECT_VERSION = [^;]*/CURRENT_PROJECT_VERSION = $NEW_BUILD_VERSION/" Lumi.xcodeproj/project.pbxproj

          echo "Updated Build Version: $NEW_BUILD_VERSION"

      - name: Determine Tag and Prerelease Status
        run: |
          BUILD_VERSION=$(xcodebuild -project ${{ env.SCHEME }}.xcodeproj -showBuildSettings 2>/dev/null | grep "CURRENT_PROJECT_VERSION" | awk '{print $3}')

          if [[ "${{ github.ref }}" == "refs/heads/pre" ]]; then
            TAG_NAME="p${{ env.new_version }}($BUILD_VERSION)"
            echo "IS_PRERELEASE=true" >> $GITHUB_ENV
            echo "## ðŸ·ï¸ Tag Info (Pre-release)" >> $GITHUB_STEP_SUMMARY
          else
            TAG_NAME="v${{ env.new_version }}"
            echo "IS_PRERELEASE=false" >> $GITHUB_ENV
            echo "## ðŸ·ï¸ Tag Info (Release)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "tag=$TAG_NAME" >> $GITHUB_ENV
          echo "- **Tag**: \`$TAG_NAME\`" >> $GITHUB_STEP_SUMMARY

      # =================================================================================================
      # 2. æž„å»ºä¸Žç­¾å
      # =================================================================================================
      - name: Setup macOS signing
        id: signing
        run: |
          chmod +x ./.github/scripts/setup-macos-signing.sh
          source ./.github/scripts/setup-macos-signing.sh
          echo "signing_identity=$SIGNING_IDENTITY" >> $GITHUB_OUTPUT
          echo "team_id=$TEAM_ID" >> $GITHUB_OUTPUT
          echo "api_key_path=$API_KEY_PATH" >> $GITHUB_OUTPUT

      - name: Build App (Archive)
        run: |
          xcodebuild archive \
            -scheme ${{ env.SCHEME }} \
            -archivePath ./temp/${{ env.SCHEME }}.xcarchive \
            -configuration Release \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="-" \
            DEVELOPMENT_TEAM="${{ steps.signing.outputs.team_id }}" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            CODE_SIGNING_REQUIRED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=YES

      - name: Codesign App
        run: |
          # ä»Ž xcarchive ä¸­æå– App (ä½¿ç”¨ ditto ä¿æŒç¬¦å·é“¾æŽ¥å’Œå…ƒæ•°æ®)
          ditto "./temp/${{ env.SCHEME }}.xcarchive/Products/Applications/${{ env.SCHEME }}.app" "./temp/${{ env.SCHEME }}.app"

          APP_PATH="./temp/${{ env.SCHEME }}.app"
          IDENTITY="${{ steps.signing.outputs.signing_identity }}"

          # ä½¿ç”¨è„šæœ¬è¿›è¡Œæ·±åº¦ç­¾å
          chmod +x .github/scripts/sign_app.sh
          .github/scripts/sign_app.sh "$APP_PATH" "$IDENTITY" "${{ env.ENTITLEMENTS_PATH }}"

      - name: Create DMG
        run: |
          STAGING_DIR="./temp/dmg_staging"
          mkdir -p "$STAGING_DIR"
          # ä½¿ç”¨ ditto æ›¿ä»£ cp -r ä»¥å®Œæ•´ä¿ç•™ Bundle ç»“æž„ã€ç¬¦å·é“¾æŽ¥å’Œå…ƒæ•°æ®
          ditto "./temp/${{ env.SCHEME }}.app" "$STAGING_DIR/${{ env.SCHEME }}.app"

          # åˆ›å»º Applications è½¯é“¾æŽ¥
          ln -s /Applications "$STAGING_DIR/Applications"

          # éªŒè¯è½¯é“¾æŽ¥æ˜¯å¦å­˜åœ¨
          echo "Checking Staging Dir:"
          ls -la "$STAGING_DIR"

          VOL_NAME="${{ env.SCHEME }}"
          DMG_NAME="./temp/${{ env.SCHEME }}_${{ env.new_version }}.dmg"
          
          hdiutil create -volname "$VOL_NAME" -srcfolder "$STAGING_DIR" -ov -format UDZO "$DMG_NAME"

      - name: Notary
        run: |
          file=$(find ./temp -name "*.dmg" -type f | head -n 1)
          if [ -z "$file" ]; then echo "DMG not found"; exit 1; fi

          # Run submit and capture output
          set +e
          xcrun notarytool submit "$file" \
            --key ${{ steps.signing.outputs.api_key_path }} \
            --key-id=${{ env.APP_STORE_CONNECT_KEY_ID }} \
            --issuer ${{ env.APP_STORE_CONNECT_KEY_ISSUER_ID }} \
            --wait \
            --timeout 10m > notary_result.txt 2>&1

          EXIT_CODE=$?
          # Output result for debugging
          cat notary_result.txt

          if [ $EXIT_CODE -ne 0 ] || grep -q "status: Invalid" notary_result.txt; then
             echo "âŒ Notarization failed. Retrieving logs..."
             # Extract ID from the output file
             SUBMISSION_ID=$(grep "id:" notary_result.txt | head -n 1 | awk '{print $2}' | tr -d ' ')
             if [ -n "$SUBMISSION_ID" ]; then
                echo "Fetching log for Submission ID: $SUBMISSION_ID"
                xcrun notarytool log "$SUBMISSION_ID" \
                  --key ${{ steps.signing.outputs.api_key_path }} \
                  --key-id=${{ env.APP_STORE_CONNECT_KEY_ID }} \
                  --issuer ${{ env.APP_STORE_CONNECT_KEY_ISSUER_ID }} 
             fi
             exit 1
          fi
          set -e

          stapler staple "$file"

      - name: Validate Notarization
        run: |
          file=$(find ./temp -name "*.dmg" -type f | head -n 1)
          stapler validate "$file"

      - name: Prepare Updates Directory
        run: |
          mkdir updates
          cp ./temp/*.dmg updates/
          ls -alh updates

      # =================================================================================================
      # 3. Appcast ç”Ÿæˆ (ä»… Release åˆ†æ”¯)
      # =================================================================================================
      - name: Generate Appcast
        if: env.IS_PRERELEASE == 'false'
        run: |
          # è§£å†³ä¾èµ–ä»¥èŽ·å– Sparkle å·¥å…·
          xcodebuild -resolvePackageDependencies
          SPARKLE_BIN=$(ls -d ~/Library/Developer/Xcode/DerivedData/${{ env.SCHEME }}*/SourcePackages/artifacts/sparkle/Sparkle/bin | head -n 1)

          if [ -d "$SPARKLE_BIN" ]; then
            cd "$SPARKLE_BIN"
            echo "${{ env.SPARKLE_PRIVATE_KEY }}" | ./generate_appcast --ed-key-file - ${{ github.workspace }}/updates
          else
            echo "âŒ Sparkle bin not found"
            exit 1
          fi

      - name: Update Appcast Link
        if: env.IS_PRERELEASE == 'false'
        run: |
          cd updates
          if [ -f appcast.xml ]; then
            dmg_file=$(ls *.dmg 2>/dev/null | head -n 1)
            if [ -n "$dmg_file" ]; then
              # å¯¹æ–‡ä»¶åè¿›è¡Œ URL ç¼–ç å¤„ç†ï¼ˆç®€å•å¤„ç†ç©ºæ ¼ï¼‰
              dmg_url_encoded=$(echo "$dmg_file" | sed 's/ /%20/g')
              
              # æž„å»ºæ–°çš„ä¸‹è½½é“¾æŽ¥
              # æ³¨æ„ï¼šSparkle ç”Ÿæˆçš„ appcast ä¸­ url å±žæ€§é€šå¸¸æ˜¯æ–‡ä»¶å
              # æˆ‘ä»¬éœ€è¦å°†å…¶æ›¿æ¢ä¸º GitHub Releases çš„å®Œæ•´ä¸‹è½½é“¾æŽ¥
              # ä½¿ç”¨ç‰¹å®šåŒ¹é…æ¨¡å¼ä»¥é¿å…è¯¯ä¼¤åŽ†å²ç‰ˆæœ¬
              
              DOWNLOAD_URL="${{ env.REPO_LINK }}/releases/download/${{ env.tag }}/$dmg_url_encoded"
              
              # æ›¿æ¢ url å±žæ€§ï¼šæŸ¥æ‰¾ url="æ–‡ä»¶å" å¹¶æ›¿æ¢ä¸º url="å®Œæ•´é“¾æŽ¥"
              # è¿™é‡Œå‡è®¾ generate_appcast ç”Ÿæˆçš„æ˜¯æ–‡ä»¶åä½œä¸º url
              sed -i '' "s|url=\"$dmg_url_encoded\"|url=\"$DOWNLOAD_URL\"|g" "appcast.xml"
              
              # ç§»åŠ¨åˆ°æ ¹ç›®å½•ä»¥ä¾¿æäº¤
              mv appcast.xml ../appcast.xml
              
              echo "Appcast updated with link: $DOWNLOAD_URL"
              cat ../appcast.xml | head -n 20
            fi
          else
             echo "âŒ appcast.xml generation failed"
             exit 1
          fi

      # =================================================================================================
      # 4. æäº¤æ›´æ”¹ä¸ŽæŽ¨é€
      # =================================================================================================
      - name: Commit and Push Changes
        if: success()
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'ci: bump to ${{ env.new_version }}'
          commit_user_name: GitHub Action
          tagging_message: ${{ env.tag }}
          push_options: '--follow-tags'
          # ä»…æäº¤é¡¹ç›®æ–‡ä»¶å’Œappcast
          file_pattern: 'Lumi.xcodeproj/project.pbxproj appcast.xml'

      # =================================================================================================
      # 5. å‘å¸ƒ Release
      # =================================================================================================
      - name: Generate Changelog
        if: success()
        run: |
          # ä½¿ç”¨åœ¨ workflow å¼€å§‹æ—¶ä¿å­˜çš„ä¸Šä¸€ä¸ªæ ‡ç­¾
          # è¿™æ ·å¯ä»¥é¿å… git-auto-commit-action åˆ›å»ºæ–° commit åŽå¯¼è‡´çš„æ ‡ç­¾æ··ä¹±
          PREVIOUS_TAG="${{ env.previous_tag }}"

          if [ -z "$PREVIOUS_TAG" ] || [ "$PREVIOUS_TAG" = "0.0.0" ]; then
            NOTES="## Release ${{ env.tag }}\n\nInitial release"
          else
            NOTES="## Release ${{ env.tag }}\n\n### Changes since v$PREVIOUS_TAG\n"
            NOTES="$NOTES\n$(git log v${PREVIOUS_TAG}..HEAD --no-merges --pretty=format:'- %s' | sort | uniq | head -20)"
          fi

          echo -e "$NOTES" > changelog.md
          cat changelog.md >> $GITHUB_STEP_SUMMARY

      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.tag }}
          prerelease: ${{ env.IS_PRERELEASE }}
          body_path: changelog.md
          files: |
            ./updates/*.dmg
            ./appcast.xml

  rebase:
    if: github.ref == 'refs/heads/main'
    needs:
      - release_pipeline
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      - name: Check pre branch
        id: check_pre
        run: |
          if git ls-remote --heads origin pre | grep -q pre; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      - name: Rebase pre on main
        if: steps.check_pre.outputs.exists == 'true'
        continue-on-error: true
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git fetch origin pre
          git checkout pre
          git rebase origin/main
          git push origin pre --force-with-lease
